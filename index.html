<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Práctica para Examen de POO</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración de Tailwind para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#f97316', // Orange-500
                        'secondary': '#10b981', // Emerald-500
                        'danger': '#ef4444', // Red-500
                        'warning': '#f59e0b', // Amber-500
                        'gemini': '#4285F4', // Blue for Gemini feature
                    }
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para el juego */
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .correct-answer {
            background-color: #d1fae5; /* Green-100 */
            border-left: 4px solid #10b981; /* Emerald-500 */
        }
        .incorrect-answer {
            background-color: #fee2e2; /* Red-100 */
            border-left: 4px solid #ef4444; /* Red-500 */
        }
        /* Estilo para elementos que parecen código */
        code {
            background-color: #e5e7eb; /* Gray-200 */
            padding: 2px 4px;
            border-radius: 4px;
            font-family: 'Consolas', 'Menlo', 'Monospace';
            font-weight: 700;
        }
        /* Estilo para el área de explicación de Gemini */
        #gemini-explanation {
            white-space: pre-wrap;
            background-color: #f0f8ff; /* Light Blue */
            border-radius: 8px;
            padding: 16px;
            border: 1px solid #d4e3f4;
            margin-top: 16px;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid #4285F4;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans flex items-center justify-center p-4">

    <div id="app" class="w-full max-w-4xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-primary mb-2">Simulador de Examen POO</h1>
            <p class="text-gray-600 text-lg">Practica con las preguntas de tus lecturas y temas.</p>
        </header>

        <!-- Contadores de Juego -->
        <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-md">
            <div class="text-center">
                <p class="text-sm font-medium text-gray-500">Puntaje</p>
                <p id="score-display" class="text-3xl font-bold text-secondary">0</p>
            </div>
            <div class="text-center">
                <p class="text-sm font-medium text-gray-500">Pregunta</p>
                <p id="question-count-display" class="text-3xl font-bold text-primary">1 / 0</p>
            </div>
            <div class="text-center">
                <p class="text-sm font-medium text-gray-500">Categoría</p>
                <p id="category-display" class="text-xl font-semibold text-gray-700">General</p>
            </div>
        </div>

        <!-- Área Principal de Pregunta -->
        <div id="quiz-area" class="bg-white p-6 md:p-10 rounded-xl card transition-all duration-300 min-h-[300px] flex flex-col justify-between">
            <div id="question-container" class="mb-6">
                <h2 class="text-xl md:text-2xl font-semibold text-gray-800 mb-4" id="question-text">Cargando pregunta...</h2>
                <div id="answer-options-container" class="space-y-4">
                    <!-- Opciones de respuesta se inyectarán aquí -->
                </div>
            </div>

            <!-- Controles y Feedback -->
            <div class="flex flex-col md:flex-row justify-between items-center pt-4 border-t border-gray-100">
                <button id="check-answer-button" onclick="checkAnswer()" class="w-full md:w-auto px-6 py-3 bg-primary text-white font-bold rounded-xl hover:bg-primary/90 transition duration-150 transform hover:scale-[1.02] shadow-lg mb-4 md:mb-0">
                    Comprobar Respuesta
                </button>
                <div id="feedback-message" class="text-lg font-bold"></div>
                <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-4 w-full md:w-auto">
                    <button id="gemini-button" onclick="getGeminiExplanation()" class="px-6 py-3 bg-gemini text-white font-bold rounded-xl hover:bg-gemini/90 transition duration-150 transform hover:scale-[1.02] shadow-lg hidden flex items-center justify-center">
                        <span class="text-2xl mr-2">✨</span> Explicación Avanzada
                    </button>
                    <button id="next-question-button" onclick="nextQuestion()" class="px-6 py-3 bg-secondary text-white font-bold rounded-xl hover:bg-emerald-600 transition duration-150 transform hover:scale-[1.02] shadow-lg hidden">
                        Siguiente Pregunta
                    </button>
                </div>
            </div>
            <!-- Área para la explicación de Gemini -->
            <div id="gemini-explanation" class="text-gray-700 text-sm hidden"></div>
        </div>

        <!-- Modal de Resultado Final -->
        <div id="final-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white p-8 rounded-xl max-w-md w-full text-center">
                <h3 class="text-3xl font-bold mb-4 text-primary">Práctica Finalizada</h3>
                <p class="text-gray-700 mb-6 text-xl">Tu puntaje final es:</p>
                <p id="final-score" class="text-6xl font-extrabold text-secondary mb-8">0/0</p>
                <button onclick="restartQuiz()" class="px-8 py-3 bg-warning text-white font-bold rounded-xl hover:bg-amber-600 transition duration-150 transform hover:scale-[1.05]">
                    Volver a Empezar
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. Definición de las Preguntas y Respuestas (Extraídas textualmente del PDF) ---
        // Total: 22 preguntas (4 Completar + 1 Emparejar + 17 V/F)
        const allQuestions = [
            // Selección Múltiple (MC) - Simula Completar - 4 preguntas
            {
                type: 'mc', category: 'Semana 2',
                question: 'Cada declaración de clase que empieza con la palabra clave ______ debe almacenarse en un archivo que tenga exactamente el mismo nombre de la clase, y que termine con la extensión de nombre de archivo <code>.java</code>.',
                options: ['private', 'protected', 'public', 'static'],
                answer: 'public',
                explanation: 'Esto es una regla fundamental: una clase solo puede ser pública si el nombre del archivo es exactamente igual al nombre de la clase, incluyendo el modificador <code>public</code>.'
            },
            {
                type: 'mc', category: 'Semana 2',
                question: 'El método ______ de <code>Scanner</code> lee caracteres hasta encontrar una nueva línea, y después devuelve esos caracteres como un objeto <code>String</code>.',
                options: ['next()', 'nextChar()', 'nextLine()', 'readString()'],
                answer: 'nextLine()',
                explanation: 'El método <code>nextLine()</code> es el que captura la línea completa de entrada, incluyendo espacios, hasta el caracter de nueva línea.'
            },
            {
                type: 'mc', category: 'Semana 2',
                question: 'No se requiere un(a) ______ si siempre hacemos referencia a una clase con su nombre de clase completamente calificado.',
                options: ['import', 'package', 'public', 'class'],
                answer: 'import',
                explanation: 'Si se utiliza el nombre de clase completamente calificado (Fully Qualified Class Name), no es necesaria la declaración <code>import</code>.'
            },
            {
                type: 'mc', category: 'Semana 4',
                question: 'La instrucción ______ selecciona una de varias acciones, con base a los posibles valores de una variable o expresión entera, o un <code>String</code>.',
                options: ['for', 'if/else', 'switch', 'do/while'],
                answer: 'switch',
                explanation: 'La instrucción <code>switch</code> es la que permite seleccionar entre múltiples bloques de código basados en el valor de una expresión (entera, enum o String en Java).'
            },

            // Emparejamiento (Matching) - 1 pregunta
            {
                type: 'matching', category: 'Semana 3',
                question: 'Empareje los elementos de la columna izquierda que correspondan con los elementos de la columna derecha (equivalencias de capacidad de almacenamiento: 1024 unidades de la anterior).',
                pairs: [
                    { left: '1 gigabyte (GB)', right: '1024 megabytes (MB)' },
                    { left: '1 terabyte (TB)', right: '1024 gigabytes (GB)' },
                    { left: '1 petabyte (PB)', right: '1024 terabytes (TB)' },
                    { left: '1 exabyte (EB)', right: '1024 petabytes (PB)' },
                    { left: '1 megabyte (MB)', right: '1024 kilobytes (KB)' }
                ]
            },

            // Verdadero/Falso (T/F) - 17 preguntas restantes
            { type: 'tf', category: 'Semana 2', question: 'La declaración <code>Import</code> no es obligatoria cuando una clase en un paquete utiliza a otra clase en el mismo paquete.', answer: true, explanation: 'Las clases dentro del mismo paquete se pueden referenciar directamente sin una declaración <code>import</code>.' },

            { type: 'tf', category: 'Semana 3', question: 'Para ejecutar un programa compilado de Java desde la línea de comandos (conocido como Símbolo del sistema en Windows), no es necesario especificar la extensión del programa compilado. Por ejemplo para ejecutar el programa compilado del archivo fuente <code>Bienvenido.java</code>, basta con escribir <code>java Bienvenido</code>.', answer: true, explanation: 'El comando <code>java</code> solo requiere el nombre de la clase (<code>Bienvenido</code>) y no la extensión <code>.class</code>.' },
            { type: 'tf', category: 'Semana 3', question: 'Para ejecutar un programa de Java, primero es compilado y después ejecutado por la Máquina Virtual de Java (JVM).', answer: true, explanation: 'El código Java se compila a bytecode, el cual es luego interpretado y ejecutado por la JVM.' },

            { type: 'tf', category: 'Semana 4', question: 'La instrucción <code>do...while</code> evalúa la condición de continuación de ciclo antes de ejecutar el cuerpo del mismo, por lo que el cuerpo siempre se ejecuta por lo menos una vez.', answer: false, explanation: 'La instrucción <code>do...while</code> evalúa la condición *después* de ejecutar el cuerpo (bucle de post-prueba), por lo que garantiza que el cuerpo se ejecute al menos una vez, incluso si la condición es falsa inicialmente.' },
            { type: 'tf', category: 'Semana 4', question: 'La expresión <code>((x > y) && (a < b))</code> es verdadera si <code>(x > y)</code> es verdadera, o si <code>(a < b)</code> es verdadera.', answer: false, explanation: 'La expresión <code>&&</code> (AND lógico) requiere que *ambas* condiciones sean verdaderas. El enunciado describe el operador <code>||</code> (OR lógico).' },
            { type: 'tf', category: 'Semana 4', question: 'Si al principio, la condición de continuación de ciclo de un encabezado <code>for</code> es falsa, el programa no ejecuta el cuerpo de la instrucción <code>for</code>.', answer: true, explanation: 'La condición se evalúa antes de la primera iteración (bucle de pre-prueba), y si es falsa, el ciclo se omite por completo.' },
            { type: 'tf', category: 'Semana 4', question: 'Al enumerar las instrucciones <code>case</code> en forma consecutiva, sin instrucciones entre ellas, se puede ejecutar las instrucciones del último <code>case</code> de la secuencia. (Esto se conoce como "fall-through")', answer: true, explanation: 'Esto es una característica del <code>switch</code> en Java (fall-through). Si se cumple un <code>case</code> y no hay <code>break</code>, la ejecución "cae" al siguiente <code>case</code>.' },

            { type: 'tf', category: 'Semana 5', question: 'Cuando una clase redefine al método de una superclase utilizando el mismo encabezado (mismos tipo de acceso, tipo de retorno, nombre de método y lista de parámetros) pero con otro cuerpo, se dice que la subclase sobrecarga a ese método de la superclase.', answer: false, explanation: 'Redefinir un método con el mismo encabezado se llama *sobrescribir* (override), no sobrecargar (overload).' },
            { type: 'tf', category: 'Semana 5', question: 'La clase <code>Object</code> es la raíz de todas las jerarquías de herencia en Java.', answer: true, explanation: 'Todas las clases en Java, directa o indirectamente, heredan de <code>Object</code>.' },
            { type: 'tf', category: 'Semana 5', question: 'Si un constructor no asigna un valor a una variable de instancia (campo), de todas formas ésta se inicializa con su valor predeterminado.', answer: true, explanation: 'Java inicializa automáticamente las variables de instancia no asignadas (ej: 0 para números, <code>false</code> para booleanos, <code>null</code> para referencias a objetos).' },

            { type: 'tf', category: 'Semana 6', question: 'Si una superclase declara a un método como <code>abstract</code>, una subclase debe forzosamente implementar ese método.', answer: false, explanation: 'Solo las subclases *concretas* (no abstractas) deben implementar todos los métodos abstractos de su superclase.' },
            { type: 'tf', category: 'Semana 6', question: 'Es posible crear un objeto de una clase abstracta si se asigna a una variable abstracta.', answer: false, explanation: 'Las clases abstractas no se pueden instanciar directamente con <code>new</code>, sin importar el tipo de la variable.' },
            { type: 'tf', category: 'Semana 6', question: 'Un método que se declara como <code>final</code> en una superclase no se puede sobrescribir en una subclase.', answer: true, explanation: 'El modificador <code>final</code> tiene el propósito específico de evitar que el método sea sobrescrito (overridden).' },
            { type: 'tf', category: 'Semana 6', question: 'Una clase abstracta debe forzosamente contener un método abstracto.', answer: false, explanation: 'Una clase se puede declarar como <code>abstract</code> incluso si no contiene ningún método <code>abstract</code>, para simplemente evitar su instanciación.' },

            { type: 'tf', category: 'Semana 7', question: 'El bloque <code>finally</code> es opcional, y si existe se debe colocar después del último bloque <code>catch</code>, o después del bloque <code>try</code> si no hay ningún bloque <code>catch</code>.', answer: true, explanation: 'El bloque <code>finally</code> siempre se ejecuta, y su posición es la correcta: al final de la estructura <code>try-catch</code>.' },
            { type: 'tf', category: 'Semana 7', question: 'Si dentro de un bloque <code>try</code> se lanza una excepción para la cual no hay una cláusula <code>catch</code> que corresponda a esa excepción, la ejecución del programa continúa en la siguiente instrucción después del último bloque <code>catch</code>.', answer: false, explanation: 'Si no se encuentra un <code>catch</code> correspondiente, la excepción se propaga y el programa termina de forma anormal (unhandled exception).' },
            { type: 'tf', category: 'Semana 7', question: 'Un bloque <code>catch</code> que atrapa una excepción de un tipo que es superclase de otros tipos de excepciones, también atrapará a estas últimas excepciones.', answer: true, explanation: 'Debido a la herencia y el polimorfismo, un bloque <code>catch</code> de un tipo base (superclase) puede manejar cualquier excepción de una subclase de ese tipo.' },
        ];

        // --- 2. Variables de Estado Globales ---
        const API_KEY = ""; // Clave API de Gemini
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${API_KEY}`;
        
        let currentQuestionIndex = 0;
        let score = 0;
        let questions = []; // Array que contendrá las preguntas barajadas
        let quizState = 'in_progress'; // 'in_progress', 'finished'

        // --- 3. Funciones de Utilidad y API de Gemini ---

        /**
         * Realiza una solicitud al API de Gemini con reintentos.
         * @param {Object} payload - Carga útil para la API.
         * @param {number} maxRetries - Número máximo de reintentos.
         * @param {number} delay - Retraso inicial en milisegundos.
         * @returns {Promise<Object>} Respuesta JSON del API.
         */
        async function fetchWithRetry(payload, maxRetries = 3, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        return response.json();
                    }
                } catch (error) {
                    console.error(`Fetch attempt ${i + 1} failed:`, error);
                }
                if (i < maxRetries - 1) {
                    await new Promise(resolve => setTimeout(resolve, delay * (2 ** i)));
                }
            }
            throw new Error("API request failed after multiple retries.");
        }


        /**
         * Obtiene una explicación avanzada de Gemini para la pregunta actual.
         */
        async function getGeminiExplanation() {
            const currentQ = questions[currentQuestionIndex];
            const explanationDiv = document.getElementById('gemini-explanation');
            const button = document.getElementById('gemini-button');
            
            explanationDiv.classList.remove('hidden');
            button.disabled = true;

            // Mostrar spinner de carga
            explanationDiv.innerHTML = '<div class="flex items-center text-gemini"><div class="spinner"></div> Generando explicación avanzada con Gemini...</div>';

            try {
                // 1. Obtener la pregunta y la respuesta (para contexto)
                let fullPrompt = currentQ.question.replace('<u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</u>', currentQ.answer);
                fullPrompt = fullPrompt.replace(/<\/?code>/g, ''); // Limpiar etiquetas <code>
                
                let answerText = `Respuesta correcta: ${currentQ.answer}`;
                if (currentQ.type === 'matching') {
                    answerText = "Relaciones correctas: " + currentQ.pairs.map(p => `${p.left} -> ${p.right}`).join("; ");
                } else if (currentQ.type === 'tf') {
                    answerText = `Respuesta correcta: ${currentQ.answer ? 'Verdadero' : 'Falso'}`;
                }

                const userQuery = `La pregunta de programación es: "${fullPrompt}". La ${answerText}. Proporciona una explicación concisa y detallada del concepto técnico detrás de esta pregunta (máximo 3 párrafos). Incluye un breve ejemplo de código en Java relevante al tema.`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: "Actúa como un profesor universitario experto en Programación Orientada a Objetos (POO) en Java. Proporciona una explicación pedagógica, estructurada y en español. Utiliza formato Markdown para el código." }]
                    },
                };

                const result = await fetchWithRetry(payload);
                
                const generatedText = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar una explicación. Inténtalo de nuevo.";
                
                // 2. Renderizar la explicación
                explanationDiv.innerHTML = `
                    <h4 class="text-lg font-semibold text-gemini mb-2 border-b border-gemini/50 pb-1">Análisis Detallado por Gemini</h4>
                    <p>${generatedText}</p>
                `;

            } catch (error) {
                console.error("Error al obtener la explicación de Gemini:", error);
                explanationDiv.innerHTML = `<span class="text-danger">Hubo un error al conectar con Gemini. Por favor, revisa la consola o inténtalo más tarde.</span>`;
            } finally {
                button.disabled = false;
            }
        }


        /**
         * Baraja un array usando el algoritmo Fisher-Yates.
         * @param {Array} array
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Inicializa el juego: baraja las preguntas y comienza.
         */
        function initializeQuiz() {
            // Clonar y barajar todas las preguntas
            questions = shuffleArray([...allQuestions]);
            currentQuestionIndex = 0;
            score = 0;
            quizState = 'in_progress';

            document.getElementById('final-modal').classList.add('hidden');
            document.getElementById('final-modal').classList.remove('flex');

            updateScoreDisplay();
            loadQuestion();
        }

        /**
         * Actualiza los contadores de puntaje y pregunta.
         */
        function updateScoreDisplay() {
            document.getElementById('score-display').textContent = score;
            document.getElementById('question-count-display').textContent = `${currentQuestionIndex + 1} / ${questions.length}`;
            const currentQ = questions[currentQuestionIndex];
            if (currentQ) {
                document.getElementById('category-display').textContent = currentQ.category;
            } else {
                document.getElementById('category-display').textContent = 'General';
            }
        }

        /**
         * Carga y renderiza la pregunta actual.
         */
        function loadQuestion() {
            // Si el índice excede el número de preguntas, finaliza el quiz.
            if (currentQuestionIndex >= questions.length) {
                endQuiz();
                return;
            }

            const currentQ = questions[currentQuestionIndex];

            // Resetear UI
            // Reemplaza el marcador de completar (______) con una línea visible en HTML
            document.getElementById('question-text').innerHTML = currentQ.question.replace('______', '<u>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</u>');
            document.getElementById('feedback-message').textContent = '';
            document.getElementById('check-answer-button').classList.remove('hidden');
            document.getElementById('next-question-button').classList.add('hidden');
            document.getElementById('gemini-button').classList.add('hidden'); // Ocultar botón de Gemini
            document.getElementById('gemini-explanation').classList.add('hidden'); // Ocultar explicación
            document.getElementById('answer-options-container').innerHTML = '';
            document.getElementById('quiz-area').classList.remove('correct-answer', 'incorrect-answer');

            // Renderizar basado en el tipo de pregunta
            if (currentQ.type === 'tf') {
                renderTrueFalse(currentQ);
            } else if (currentQ.type === 'mc') {
                // Las preguntas de Completar se renderizan como Selección Múltiple
                renderMultipleChoice(currentQ);
            } else if (currentQ.type === 'matching') {
                renderMatching(currentQ);
            }

            updateScoreDisplay();
        }

        // --- 4. Funciones de Renderizado por Tipo de Pregunta ---

        /**
         * Renderiza la pregunta Verdadero/Falso.
         * @param {Object} q - Objeto de pregunta.
         */
        function renderTrueFalse(q) {
            const container = document.getElementById('answer-options-container');
            container.innerHTML = `
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                    <label class="flex items-center p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors w-full">
                        <input type="radio" name="tf_answer" value="true" class="h-5 w-5 text-primary focus:ring-primary">
                        <span class="ml-3 text-lg font-medium text-gray-700">Verdadero</span>
                    </label>
                    <label class="flex items-center p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors w-full">
                        <input type="radio" name="tf_answer" value="false" class="h-5 w-5 text-primary focus:ring-primary">
                        <span class="ml-3 text-lg font-medium text-gray-700">Falso</span>
                    </label>
                </div>
            `;
        }

        /**
         * Renderiza la pregunta de Selección Múltiple (Completar).
         * @param {Object} q - Objeto de pregunta.
         */
        function renderMultipleChoice(q) {
            const container = document.getElementById('answer-options-container');
            const shuffledOptions = shuffleArray([...q.options]); // Barajar opciones
            container.innerHTML = shuffledOptions.map(option => `
                <label class="flex items-center p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-200 transition-colors">
                    <input type="radio" name="mc_answer" value="${option}" class="h-5 w-5 text-primary focus:ring-primary radio-option">
                    <span class="ml-3 text-lg font-medium text-gray-700">${option}</span>
                </label>
            `).join('');
        }

        /**
         * Renderiza la pregunta de Emparejamiento.
         * @param {Object} q - Objeto de pregunta.
         */
        function renderMatching(q) {
            const container = document.getElementById('answer-options-container');
            const leftOptions = q.pairs.map(p => p.left);
            const rightOptions = q.pairs.map(p => p.right);
            const shuffledRight = shuffleArray([...rightOptions]); // Barajar el lado derecho

            container.classList.add('space-y-3');
            container.innerHTML = leftOptions.map((leftItem, index) => `
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center bg-gray-50 p-3 rounded-lg matching-pair" data-left="${leftItem}">
                    <span class="font-medium text-gray-700 w-full sm:w-1/2 mb-2 sm:mb-0">${leftItem}</span>
                    <select id="select_${index}" class="form-select mt-1 block w-full sm:w-1/2 rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary p-2 matching-select" data-correct-right="${q.pairs.find(p => p.left === leftItem).right}">
                        <option value="">Elegir...</option>
                        ${shuffledRight.map(rightItem => `<option value="${rightItem}">${rightItem}</option>`).join('')}
                    </select>
                </div>
            `).join('');
        }

        // --- 5. Funciones de Verificación de Respuesta ---

        /**
         * Comprueba la respuesta del usuario para la pregunta actual.
         */
        function checkAnswer() {
            const currentQ = questions[currentQuestionIndex];
            let isCorrect = false;

            if (currentQ.type === 'tf') {
                isCorrect = checkTrueFalse(currentQ);
            } else if (currentQ.type === 'mc') {
                isCorrect = checkMultipleChoice(currentQ);
            } else if (currentQ.type === 'matching') {
                isCorrect = checkMatching(currentQ);
            }

            if (isCorrect) {
                score++;
                document.getElementById('feedback-message').innerHTML = `<span class="text-secondary">¡Correcto!</span>`;
                document.getElementById('quiz-area').classList.add('correct-answer');
            } else {
                document.getElementById('feedback-message').innerHTML = `<span class="text-danger">Incorrecto.</span><br><span class="text-sm font-normal text-gray-600"><strong>Explicación:</strong> ${currentQ.explanation}</span>`;
                document.getElementById('quiz-area').classList.add('incorrect-answer');
            }

            // Deshabilitar botón de comprobar y mostrar siguiente + Gemini
            document.getElementById('check-answer-button').classList.add('hidden');
            document.getElementById('next-question-button').classList.remove('hidden');
            document.getElementById('gemini-button').classList.remove('hidden'); // Mostrar botón de Gemini
            updateScoreDisplay();
            disableOptions(currentQ.type);
        }

        /**
         * Deshabilita las opciones de respuesta después de la comprobación.
         * @param {string} type - Tipo de pregunta.
         */
        function disableOptions(type) {
            if (type === 'tf') {
                document.querySelectorAll('input[name="tf_answer"]').forEach(input => input.disabled = true);
            } else if (type === 'mc') {
                document.querySelectorAll('input[name="mc_answer"]').forEach(input => {
                    input.disabled = true;
                    // Resaltar respuesta correcta
                    if (input.value === questions[currentQuestionIndex].answer) {
                        input.parentElement.classList.add('border-2', 'border-secondary', 'bg-emerald-100');
                    }
                });
            } else if (type === 'matching') {
                document.querySelectorAll('.matching-select').forEach(select => {
                    select.disabled = true;
                    const correctValue = select.getAttribute('data-correct-right');
                    // Resaltar correctos/incorrectos
                    const parentDiv = select.closest('.matching-pair');
                    if (select.value === correctValue) {
                         parentDiv.classList.add('border-2', 'border-secondary', 'bg-emerald-100');
                    } else if (select.value !== "") {
                        parentDiv.classList.add('border-2', 'border-danger', 'bg-red-100');
                    }
                    parentDiv.innerHTML += `<span class="text-sm text-gray-700 mt-1 sm:mt-0 sm:ml-4"> (Correcto: ${correctValue})</span>`;
                });
            }
        }


        /**
         * Lógica de comprobación para Verdadero/Falso.
         * @param {Object} q - Objeto de pregunta.
         * @returns {boolean}
         */
        function checkTrueFalse(q) {
            const selected = document.querySelector('input[name="tf_answer"]:checked');
            if (!selected) return false;
            return selected.value === q.answer.toString();
        }

        /**
         * Lógica de comprobación para Selección Múltiple.
         * @param {Object} q - Objeto de pregunta.
         * @returns {boolean}
         */
        function checkMultipleChoice(q) {
            const selected = document.querySelector('input[name="mc_answer"]:checked');
            if (!selected) return false;
            return selected.value === q.answer;
        }

        /**
         * Lógica de comprobación para Emparejamiento.
         * @param {Object} q - Objeto de pregunta.
         * @returns {boolean}
         */
        function checkMatching(q) {
            const selects = document.querySelectorAll('.matching-select');
            let allCorrect = true;

            selects.forEach(select => {
                const correctValue = select.getAttribute('data-correct-right');
                if (select.value !== correctValue) {
                    allCorrect = false;
                }
            });

            return allCorrect;
        }

        /**
         * Pasa a la siguiente pregunta o finaliza el quiz.
         */
        function nextQuestion() {
            currentQuestionIndex++;
            loadQuestion();
        }

        /**
         * Muestra el modal de resultados finales.
         */
        function endQuiz() {
            document.getElementById('final-score').textContent = `${score} / ${questions.length}`;
            document.getElementById('final-modal').classList.remove('hidden');
            document.getElementById('final-modal').classList.add('flex');
        }

        /**
         * Reinicia el quiz.
         */
        function restartQuiz() {
            initializeQuiz();
        }

        // Inicializar el quiz cuando la ventana cargue
        window.onload = initializeQuiz;
    </script>
</body>
</html>
